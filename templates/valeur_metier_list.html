<!-- templates/valeur_metier_list.html -->
{% extends "base.html" %}
{% block title %}Valeurs m√©tier{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8">
  <h1 class="text-3xl font-bold mb-8 text-blue-600">Valeurs m√©tier</h1>

  <!-- Barre de recherche + bouton Ajouter -->
  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <form method="get" action="{{ url_for('valeurs_metier.liste_valeurs') }}" class="flex items-center gap-2">
      <input type="text" name="q" value="{{ request.args.get('q','') }}"
             placeholder="Rechercher libell√© / type / valeur / pond√©ration..."
             class="border border-gray-300 rounded-lg px-4 py-2 text-sm w-80 focus:ring-blue-400 focus:border-blue-400">
      <button type="submit"
              class="bg-white border border-gray-300 px-3 py-2 rounded text-blue-600 hover:text-blue-800 transition">
        üîç
      </button>
    </form>

    <button onclick="openAddModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-full shadow-lg">
      ‚ûï Ajouter une valeur m√©tier
    </button>
  </div>

  <!-- Tableau -->
  <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200">
    <table class="min-w-full bg-white divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Libell√©</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Type Libell√©</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Valeur Libell√©</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Pond√©ration</th>
          <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for val in valeurs %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-6 py-4 text-sm text-gray-800">{{ val.libelle }}</td>
          <td class="px-6 py-4 text-sm text-gray-700">{{ val.type_libelle }}</td>
          <td class="px-6 py-4 text-sm text-gray-700">{{ val.valeur_libelle }}</td>
          <td class="px-6 py-4 text-sm text-gray-700">{{ val.ponderation }}</td>
          <td class="px-6 py-4">
            <div class="flex items-center justify-center gap-3">
              <button type="button"
                      onclick='openEditModal({{ val.id|tojson }}, {{ val.libelle|tojson }}, {{ val.type_libelle|tojson }}, {{ val.valeur_libelle|tojson }}, {{ val.ponderation|tojson }})'
                      class="p-2 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-600"
                      title="Modifier">‚úèÔ∏è</button>
              <form action="{{ url_for('valeurs_metier.supprimer_valeur', id=val.id) }}" method="post" class="inline">
                <button type="submit" onclick="return confirm('Supprimer {{ val.libelle }} ?')"
                        class="p-2 rounded-full bg-red-50 hover:bg-red-100 text-red-600" title="Supprimer">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center px-6 py-6 text-gray-500">Aucune valeur m√©tier trouv√©e</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="flex justify-center items-center mt-6 gap-6">
    {% if page > 1 %}
      <a href="{{ url_for('valeurs_metier.liste_valeurs', page=page-1, q=request.args.get('q','')) }}"
         class="text-blue-600 hover:text-blue-800 text-lg">‚¨ÖÔ∏è</a>
    {% endif %}
    <span class="text-gray-700 text-sm font-semibold">{{ page }}/{{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="{{ url_for('valeurs_metier.liste_valeurs', page=page+1, q=request.args.get('q','')) }}"
         class="text-blue-600 hover:text-blue-800 text-lg">‚û°Ô∏è</a>
    {% endif %}
  </div>
</div>

<!-- ===== MODAL AJOUT ===== -->
<div id="addModal" class="fixed inset-0 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div id="addModalContent" class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform scale-95 opacity-0 transition-all duration-300 ease-out">
    <h2 class="text-xl font-bold mb-4 text-blue-600">Ajouter une Valeur M√©tier</h2>
    <form method="POST" action="{{ url_for('valeurs_metier.ajouter_valeur') }}">
      <div class="mb-3">
  <label class="block text-sm font-medium">Libell√©</label>
  <select id="libelleAdd" name="libelle" required class="w-full border px-3 py-2 rounded">
    <option value="">-- S√©lectionner un libell√© --</option>
  </select>
</div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Type Libell√©</label>
        <select id="typeLibelleAdd" name="type_libelle" required class="w-full border px-3 py-2 rounded">
          <option value="">-- S√©lectionner un type --</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Valeur Libell√©</label>
        <select id="valeurLibelleAdd" name="valeur_libelle" required class="w-full border px-3 py-2 rounded">
          <option value="">-- S√©lectionner une valeur --</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Pond√©ration</label>
        <input type="number" name="ponderation" required class="w-full border px-3 py-2 rounded">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeAddModal()" class="px-4 py-2 rounded bg-gray-200">Annuler</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== MODAL EDIT ===== -->
<div id="editModal" class="fixed inset-0 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div id="editModalContent" class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform scale-95 opacity-0 transition-all duration-300 ease-out">
    <h2 class="text-xl font-bold mb-4 text-blue-600">Modifier la Valeur M√©tier</h2>
    <form id="editForm" method="POST">
      <div class="mb-3">
        <label class="block text-sm font-medium">Libell√©</label>
        <input type="text" id="editLibelle" name="libelle" readonly class="w-full border px-3 py-2 rounded bg-gray-100">
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Type Libell√©</label>
        <select id="edittypeLibelle" name="type_libelle" required class="w-full border px-3 py-2 rounded">
          <option value="">-- S√©lectionner un type --</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Valeur Libell√©</label>
        <select id="editValeurLibelle" name="valeur_libelle" required class="w-full border px-3 py-2 rounded">
          <option value="">-- S√©lectionner une valeur --</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Pond√©ration</label>
        <input type="number" id="editPonderation" name="ponderation" required class="w-full border px-3 py-2 rounded">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 rounded bg-gray-200">Annuler</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Mettre √† jour</button>
      </div>
    </form>
  </div>
</div>

<script>
// ---------- FONCTIONS MODALS ----------
function openAddModal() {
  const modal = document.getElementById("addModal");
  const content = document.getElementById("addModalContent");
  modal.classList.remove("hidden");
  setTimeout(() => {
    content.classList.remove("scale-95","opacity-0");
    content.classList.add("scale-100","opacity-100");
  }, 10);
}
function closeAddModal() {
  const modal = document.getElementById("addModal");
  const content = document.getElementById("addModalContent");
  content.classList.remove("scale-100","opacity-100");
  content.classList.add("scale-95","opacity-0");
  setTimeout(() => modal.classList.add("hidden"), 150);
}

function openEditModal(id, libelle, typeLibelle, valeurLibelle, ponderation) {
  // champs simples
  document.getElementById("editLibelle").value = libelle || '';
  document.getElementById("editPonderation").value = ponderation || '';
  document.getElementById("editForm").action = "/valeurs/modifier/" + id;

  const typeSelect = document.getElementById("edittypeLibelle");
  const valeurSelect = document.getElementById("editValeurLibelle");

  // reset visuel
  typeSelect.innerHTML = '<option value="">Chargement...</option>';
  valeurSelect.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';

// Charger la liste des libell√©s au d√©marrage
fetch("/valeurs/get_libelles")
  .then(r => r.json())
  .then(data => {
    const libelleAdd = document.getElementById("libelleAdd");
    libelleAdd.innerHTML = '<option value="">-- S√©lectionner un libell√© --</option>';
    (data.libelles || []).forEach(lib => {
      const opt = document.createElement("option");
      opt.value = lib;
      opt.textContent = lib;
      libelleAdd.appendChild(opt);
    });
  })
  .catch(err => {
    console.error("Erreur chargement libell√©s:", err);
  });

  // charger les types du libell√©
  fetch(`/valeurs/get_types/${encodeURIComponent(libelle || '')}`)
    .then(r => r.json())
    .then(data => {
      typeSelect.innerHTML = '<option value="">-- S√©lectionner un type --</option>';
      (data.types || []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        if (t === (typeLibelle || '')) opt.selected = true;
        typeSelect.appendChild(opt);
      });

      // charger les valeurs du type s√©lectionn√©
      if (typeLibelle) {
        fetch(`/valeurs/get_valeurs/${encodeURIComponent(libelle || '')}/${encodeURIComponent(typeLibelle || '')}`)
          .then(r => r.json())
          .then(vdata => {
            valeurSelect.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';
            (vdata.valeurs || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v;
              opt.textContent = v;
              if (v === (valeurLibelle || '')) opt.selected = true;
              valeurSelect.appendChild(opt);
            });
          })
          .catch(err => {
            console.error('Erreur chargement valeurs (edit):', err);
            valeurSelect.innerHTML = '<option value="">(Erreur chargement)</option>';
          });
      }
    })
    .catch(err => {
      console.error('Erreur chargement types (edit):', err);
      typeSelect.innerHTML = '<option value="">(Erreur chargement)</option>';
    });

  const modal = document.getElementById("editModal");
  const content = document.getElementById("editModalContent");
  modal.classList.remove("hidden");
  setTimeout(() => {
    content.classList.remove("scale-95","opacity-0");
    content.classList.add("scale-100","opacity-100");
  }, 10);
}

function closeEditModal() {
  const modal = document.getElementById("editModal");
  const content = document.getElementById("editModalContent");
  content.classList.remove("scale-100","opacity-100");
  content.classList.add("scale-95","opacity-0");
  setTimeout(() => modal.classList.add("hidden"), 150);
}


// ---------- D√âPENDANCES ADD + EDIT ----------
document.addEventListener('DOMContentLoaded', () => {
  const libelleAdd = document.getElementById('libelleAdd');
  const typeLibelleAdd = document.getElementById('typeLibelleAdd');
  const valeurLibelleAdd = document.getElementById('valeurLibelleAdd');

  // ADD: libell√© -> types
  if (libelleAdd && typeLibelleAdd && valeurLibelleAdd) {
    libelleAdd.addEventListener('change', () => {
      const libelle = libelleAdd.value.trim();
      typeLibelleAdd.innerHTML = '<option value="">Chargement...</option>';
      valeurLibelleAdd.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';

      if (!libelle) {
        typeLibelleAdd.innerHTML = '<option value="">-- S√©lectionner un type --</option>';
        return;
      }

      fetch(`/valeurs/get_types/${encodeURIComponent(libelle)}`)
        .then(r => r.json())
        .then(data => {
          typeLibelleAdd.innerHTML = '<option value="">-- S√©lectionner un type --</option>';
          (data.types || []).forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            typeLibelleAdd.appendChild(opt);
          });
        })
        .catch(err => {
          console.error('Erreur chargement types (add):', err);
          typeLibelleAdd.innerHTML = '<option value="">(Erreur chargement)</option>';
        });
    });

    // ADD: type -> valeurs
    typeLibelleAdd.addEventListener('change', () => {
      const libelle = (libelleAdd.value || '').trim();
      const type = typeLibelleAdd.value;
      valeurLibelleAdd.innerHTML = '<option value="">Chargement...</option>';

      if (!libelle || !type) {
        valeurLibelleAdd.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';
        return;
      }

      fetch(`/valeurs/get_valeurs/${encodeURIComponent(libelle)}/${encodeURIComponent(type)}`)
        .then(r => r.json())
        .then(data => {
          valeurLibelleAdd.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';
          (data.valeurs || []).forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            valeurLibelleAdd.appendChild(opt);
          });
        })
        .catch(err => {
          console.error('Erreur chargement valeurs (add):', err);
          valeurLibelleAdd.innerHTML = '<option value="">(Erreur chargement)</option>';
        });
    });
  }

  // EDIT: si on change le type dans le modal, recharger les valeurs
  const edType = document.getElementById('edittypeLibelle');
  const edValeur = document.getElementById('editValeurLibelle');
  const edLib = document.getElementById('editLibelle');

  if (edType && edValeur && edLib) {
    edType.addEventListener('change', () => {
      const libelle = (edLib.value || '').trim();
      const type = edType.value;
      edValeur.innerHTML = '<option value="">Chargement...</option>';

      if (!libelle || !type) {
        edValeur.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';
        return;
      }

      fetch(`/valeurs/get_valeurs/${encodeURIComponent(libelle)}/${encodeURIComponent(type)}`)
        .then(r => r.json())
        .then(data => {
          edValeur.innerHTML = '<option value="">-- S√©lectionner une valeur --</option>';
          (data.valeurs || []).forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            edValeur.appendChild(opt);
          });
        })
        .catch(err => {
          console.error('Erreur chargement valeurs (edit change type):', err);
          edValeur.innerHTML = '<option value="">(Erreur chargement)</option>';
        });
    });
  }
});
</script>
{% endblock %}

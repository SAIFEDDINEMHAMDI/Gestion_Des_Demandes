{% extends "base.html" %}
{% block title %}Valeurs métier{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-6 py-8">
  <h1 class="text-3xl font-bold mb-8 text-blue-600">Valeurs métier</h1>

  <!-- Recherche + bouton ajout -->
  <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <form method="get" action="{{ url_for('valeurs_metier.liste_valeurs') }}" class="flex items-center gap-2">
      <div class="relative">
        <input type="text" name="search" value="{{ request.args.get('search','') }}"
               placeholder="Rechercher libellé ou pondération..."
               class="border border-gray-300 rounded-lg px-4 py-2 text-sm w-72 focus:ring-blue-400 focus:border-blue-400">
        <button type="submit"
                class="absolute right-2 top-1/2 -translate-y-1/2 bg-white px-2 py-1 rounded text-blue-600 hover:text-blue-800 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387a1 1 0 01-1.414 1.414l-4.387-4.387zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
    </form>

    <button onclick="openAddModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-full shadow-lg flex items-center gap-2 transition">
      ➕ Ajouter une valeur métier
    </button>
  </div>

  <!-- Tableau -->
  <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200">
    <table class="min-w-full bg-white divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Libellé</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Pondération</th>
          <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for val in valeurs %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-6 py-4 text-sm text-gray-800">{{ val.libelle }}</td>
          <td class="px-6 py-4 text-sm font-medium text-gray-700">{{ val.ponderation }}</td>
          <td class="px-6 py-4 flex items-center justify-center gap-4">
            <!-- Modifier -->
            <button type="button"
                    onclick="openEditModal('{{ val.id }}','{{ val.libelle|e }}','{{ val.ponderation }}')"
                    class="inline-flex items-center justify-center p-2 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-600 hover:text-blue-700 transition"
                    title="Modifier">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/>
                <path fill-rule="evenodd" d="M4 16a1 1 0 011-1h9a1 1 0 110 2H5a1 1 0 01-1-1z" clip-rule="evenodd"/>
              </svg>
            </button>
            <!-- Supprimer -->
            <form action="{{ url_for('valeurs_metier.supprimer_valeur', id=val.id) }}" method="post" class="inline">
              <button type="submit"
                      onclick="return confirm('Supprimer {{ val.libelle }} ?')"
                      class="inline-flex items-center justify-center p-2 rounded-full bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 transition"
                      title="Supprimer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="3" class="text-center px-6 py-4 text-gray-500">Aucune valeur métier trouvée</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="flex justify-center items-center mt-6 gap-6">
    {% if page > 1 %}
    <a href="{{ url_for('valeurs_metier.liste_valeurs', page=page-1, search=request.args.get('search','')) }}"
       class="text-blue-600 hover:text-blue-800 text-lg">⬅️</a>
    {% endif %}
    <span class="text-gray-700 text-sm font-semibold">{{ page }}/{{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="{{ url_for('valeurs_metier.liste_valeurs', page=page+1, search=request.args.get('search','')) }}"
       class="text-blue-600 hover:text-blue-800 text-lg">➡️</a>
    {% endif %}
  </div>
</div>

<!-- MODAL AJOUT -->
<div id="addModal" class="fixed inset-0 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div id="addModalContent"
       class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform scale-95 opacity-0 transition-all duration-300 ease-out">
    <h2 class="text-xl font-bold mb-4 text-blue-600">Ajouter une Valeur Métier</h2>
    <form method="POST" action="{{ url_for('valeurs_metier.ajouter_valeur') }}">
      <div class="mb-3">
        <label class="block text-sm font-medium">Libellé</label>
        <input type="text" name="libelle" required class="w-full border px-3 py-2 rounded">
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Pondération</label>
        <input type="number" name="ponderation" required class="w-full border px-3 py-2 rounded">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeAddModal()" class="px-4 py-2 rounded bg-gray-200">Annuler</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL EDIT -->
<div id="editModal" class="fixed inset-0 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div id="editModalContent"
       class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform scale-95 opacity-0 transition-all duration-300 ease-out">
    <h2 class="text-xl font-bold mb-4 text-blue-600">Modifier la Valeur Métier</h2>
    <form id="editForm" method="POST">
      <div class="mb-3">
        <label class="block text-sm font-medium">Libellé</label>
        <input type="text" id="editLibelle" name="libelle" required class="w-full border px-3 py-2 rounded">
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Pondération</label>
        <input type="number" id="editPonderation" name="ponderation" required class="w-full border px-3 py-2 rounded">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 rounded bg-gray-200">Annuler</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Mettre à jour</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --- ADD MODAL ---
  function openAddModal() {
    const modal = document.getElementById("addModal");
    const content = document.getElementById("addModalContent");
    modal.classList.remove("hidden");
    setTimeout(() => {
      content.classList.remove("scale-95","opacity-0");
      content.classList.add("scale-100","opacity-100");
    }, 50);
  }
  function closeAddModal() {
    const modal = document.getElementById("addModal");
    const content = document.getElementById("addModalContent");
    content.classList.remove("scale-100","opacity-100");
    content.classList.add("scale-95","opacity-0");
    setTimeout(() => modal.classList.add("hidden"), 200);
  }

  // --- EDIT MODAL ---
  function openEditModal(id, libelle, ponderation) {
    document.getElementById("editLibelle").value = libelle;
    document.getElementById("editPonderation").value = ponderation;
    document.getElementById("editForm").action = "/valeurs/modifier/" + id;

    const modal = document.getElementById("editModal");
    const content = document.getElementById("editModalContent");
    modal.classList.remove("hidden");
    setTimeout(() => {
      content.classList.remove("scale-95","opacity-0");
      content.classList.add("scale-100","opacity-100");
    }, 50);
  }
  function closeEditModal() {
    const modal = document.getElementById("editModal");
    const content = document.getElementById("editModalContent");
    content.classList.remove("scale-100","opacity-100");
    content.classList.add("scale-95","opacity-0");
    setTimeout(() => modal.classList.add("hidden"), 200);
  }
</script>
{% endblock %}
